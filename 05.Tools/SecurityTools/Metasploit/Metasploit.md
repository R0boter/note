# 渗透测试简单介绍

## 起源和定义

起源：20 世纪 90 年代，由美国军方与国家安全局引入的对信息网络与信息安全基础设施的实际攻防测试过程，由攻击者「红队」和防御者「蓝队」，以实战方式检验目标系统安全防御体系与安全响应计划的有效性。最终这种通过实际攻击进行安全测试和评估的方法拓展到安全业界，企业通过这种方式对自己的业务网络和系统进行测试

定义：渗透测试就是一种通过模拟恶意攻击者的技术和方法，挫败目标系统安全控制措施，取得访问控制权，并发现具备业务影响后果安全隐患的一种安全测试与评估方式

## 分类

1. 黑盒测试：即外部测试。完全模拟真实网络环境中的外部攻击者，采用流行发攻击技术和工具，有组织有步骤的对目标组织进行渗透和入侵。黑盒测试比较费时费力，且对渗透者要求较高的技术能力，还能对目标的检测和应急响应能力

2. 白盒测试：即内部测试。测试者会获取到目标环境中的所有内部和底层知识，使渗透者用最小的代价发现和验证目标系统中的安全漏洞，白盒测试更容易全面的发现目标存在的漏洞，但不能很好的检测目标的检测和应急响应能力

3. 灰盒测试：综合黑盒和白盒测试，普遍采用此种方法


## 方法和流程

### 方法

1. 安全测试方法学开源手册：由 ISECOM 安全与公开方法学研究所制定，安全测试方法学开源手册（OSSTMM）提供物理安全、人类心理学、数据网络、无线通信媒介、电讯通信这五类测试用例和测试结果的指标标准。其特色是分成注重技术的细节

2. NIST SP 800-42 网络安全测试指南：美国国家标准和技术研究院（NIST）再 SP 800-42 网络安全测试指南中讨论了渗透测试流程和方法。

3. OWASP 十大 Web 应用安全威胁项目：针对 Web 应用层提供的如何识别和避免这些安全威胁的指南。OWASP Top Ten 只关注具有高风险的 Web 领域。

4. Web 安全威胁分类标准：和 OWASP Top Ten 类似，WASC-TC 全面给出 Web 应用领域中的漏洞、攻击、防范措施视图

5. PTES 渗透测试执行标准：2010 年最新发起的渗透测试过程规范标准项目，安全业界的广泛认同

### 流程

1. 前期交互：Pre-Engagement Interaction 阶段是和客户确定渗透测试的范围、目标、限制条件和服务合同细节

2. 情报搜集：Information Gathering 阶段，利用各种信息来源和搜集技术方法，尝试获取目标组织的网络拓扑、系统配置、安全防御措施的信息
    > 情报搜集方法：公开来源信息查询、Google Hacking、社会工程学、网络踩点、扫描探测、被动监听、服务查点

3. 威胁建模：Threat Modeling 阶段通过获取的信息进行分析，确定可行的攻击通道和攻击规划、以及目标的潜在威胁点

4. 漏洞分析：Vulnerability Analysis 阶段利用前几个阶段获取的信息，找出可进行渗透攻击的攻击点，并搭建实验环境进行验证，和对系统和服务的安全漏洞深度挖掘，开发相应的渗透代码

5. 渗透工具：Exploitation 阶段是利用已找到的目标存在的漏洞来入侵目标，获取访问控制权限。黑盒测试还要考虑对系统检测机制的逃逸，避免造成目标响应团队的警觉和发现

6. 后渗透攻击阶段：Post Exploitation 阶段需要根据目标组织的业务经营模式、保护资产形式、安全防御计划的不同，设计出攻击目标，识别关键的基础设施，寻找客户最具价值和尝试安全保护的信息和字长，最终达成能够对客户组织造成最重要业务影响的攻击途径

7. 报告：Reporting 阶段，将获取的关键情报信息、探测和发掘的系统安全漏洞、成功渗透过程、造成业务影响后果的攻击途径进行整理，还要分析目标安全防御体系的薄弱环节、存在的问题、修补和升级方案

## 安全漏洞生命周期

1. 安全漏洞的研究和挖掘：利用源代码审计（白盒测试）、逆向工程（灰盒测试）、Fuzz 测试（黑盒测试）挖掘目标系统中存有的可被利用的安全漏洞

2. 渗透代码开发和测试：开发概念验证性的渗透攻击代码（POC），用于验证找到的漏洞是否确实存在

3. 封闭团队中的流传：当 POC 被验证漏洞确实存在后，「白帽子」会通知厂商进行修补，厂商给出补丁后，再进行公布。而「黑帽子」和「灰帽子」则会在封闭团队中秘密共享，以充分利用安全漏洞和渗透攻击代码带来的攻击价值

4. 安全漏洞和渗透代码扩散：当封闭团队中的安全漏洞和渗透代码被披露后，开始在安全社区快速扩散。更多的「黑帽子」快速对其进行掌握和应用

5. 恶意程序的传播：「黑帽子」在渗透代码的基础上开发出更易使用、更具自动化传播能力的恶意程序，在黑客社区和互联网上进行传播

6. 渗透代码和恶意程序大规模传播：更多的「黑帽子」从社区或互联网获取到恶意程序，对互联网的危害达到顶峰

7. 渗透攻击代码、攻击工具、恶意程序逐渐消亡：在厂商补丁程序、安全公司的检测和移除机制广泛应用后，相应的渗透代码、恶意程序将被「黑帽子」逐渐抛弃

## 安全漏洞公共资源库

1. 中国国家漏洞库                                            ： [CNNVD](www.cnnvd.org.cn)

2. 中国国家信息安全漏洞共享平台                              ： [CNCERT/CC](www.cnvd.org.cn)

3. 乌云安全漏洞报告平台                                      ： [乌云](www.wooyun.org)

4. 通用漏洞与披露(Common Vulnerability and Exposures)        ： [CVE](cve.mitre.org)

5. 国家漏洞数据库(National Vulnerability Database)           ： [NVD](nvd.nist.gov)

6. 赛门铁克漏洞库(起源于Bugtraq邮件列表，02年被赛门铁克收购) ： [SecurityFocus](www.securityfocus.com)

7. [Metasploit](www.metasploit.com/modules)

8. [Exploit-db](https://www.exploit-db.com/)

9. [PackerStorm](https://packetstormsecurity.com/files/tags/exploit/)

10. [SecurityVulns](https://vulners.com/)

11. [1337Day](https://0day.today/)

# Metasploit Framework 基础知识

## 结构

1. 基础库文件：分为 Rex(Ruby Extension)、framework-core、framework-base
    
    1. Rex 是 Metasploit 框架所依赖的最基础的组件，为 Metasploit 开发者进行框架和模块开发提供基础功能支持，如包装的网络套接字、网络应用协议客户端和服务端的实现、日志子系统、渗透攻击支持例程、PostgreSQL 及 MySQL 数据库支持
    2. framework-core 库负责实现所有与各种类型的上层模块及插件的交互接口
    3. framework-base 库扩展了 framework-core，提供更简单的包装例程，并为处理框架各个方面的功能提供了一些功能类，用于支持用户接口和功能程序调用框架本身功能及框架内的集成模块

2. 模块：通过 Metasploit 框架装载、集成并对外提供最核心的渗透测试功能的实现代码。分为辅助模块(Aux)、渗透攻击模块(Exploits)、后渗透攻击模块(Post)、攻击载荷模块(Payloads)、空指令模块(Nops)、编码器模块(Encoders)

3. 插件：插件可以集成现有的一些外部安全工具，如 Nessus、OpenVAS

4. 接口：Metasploit 框架提供多种用户使用接口，包括 msfconsole 控制台终端、msfgui 图形化界面、armitage 图形化界面、msfapi 远程调用接口

5. 功能程序：用来支持渗透测试者快速利用 Metasploit 框架内部能力完成特定任务的程序，如 msfpayload、msfencode、msfvenom可以将攻击载荷封装为可执行文件、C 语言、JavaScript 语言等多种形式，并可以进行各种类型的编码。而 msf\*scan 系列功能程序提供了在 PE、ELF 等各种类型文件中搜索指定指令的功能，用于定位指令地址。

## 模块详解

1. 辅助模块：为渗透测试的信息收集提供支持，包括针对各种网络服务的扫描和查点、构建虚假服务收集登录密码、口令猜解、敏感信息嗅探、探查敏感信息泄露、Fuzz 测试发掘漏洞、实施网络协议欺骗等。此外还包含一些无须加载的攻击载荷，如拒绝服务攻击

2. 渗透攻击模块：利用发现的安全漏洞或配置弱点对远程目标系统进行攻击，以植入和运行攻击载荷，从而获得对远程目标系统访问器的代码组件。Metasploit 是以目标系统的操作系统平台以及所针对的网络服务或应用程序类型来对渗透攻击模块进行分类。其支持的有 Windows、Linux、Apple iOS、Mac OS X、UNIX(包括 AIX、BSDi、FreeBSD、HPUX、IRIX、Solaris等)、NetWare 等不同操作系统平台其中最多的有 Windows、UNIX、Linux、Mac OS X，而 Multi 平台类中包含一些跨平台的网络服务或应用程序中存在的安全漏洞。如 Samba、Tomcat、Firefox。而 Metasploit 中的渗透攻击模块可以按照所利用的安全漏洞所在位置分为主动渗透攻击和被动渗透攻击两大类
    
    1. 主动渗透攻击：利用的安全漏洞位于网络服务端软件与服务承载的上层应用程序之中，这些服务通常是在主机上监听端口并等待客户端的连接，因此可以主动发起渗透攻击。主动渗透攻击属于传统的渗透攻击，在 Metasploit 中占主流位置
    2. 被动渗透攻击：利用的安全漏洞位于客户端软件中，如浏览器、浏览器插件、电子邮件客户端、Office 与 Adobe 等各种文档阅读与编辑软件。通过构造恶意的网页、电子邮件、文档文件，并通过架设包含此类恶意内容的服务端、发送邮件附件、结合社会工程学分发和诱骗用户打开、结合网络欺骗和劫持技术等方式使目标系统上的用户触发此类安全漏洞。被动渗透通常可以绕过网络边界防护措施，如防火墙等。常见的两类被动渗透攻击为浏览器软件漏洞攻击和文件格式类漏洞攻击

3. 攻击载荷模块：















































